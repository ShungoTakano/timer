<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ブラウザタイマー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 7セグメントフォントの読み込み（ローカルファイル） */
        @font-face {
            font-family: 'DSEG7 Modern';
            src: url('font/DSEG7Modern-Bold.woff2') format('woff2'),
                 url('font/DSEG7Modern-Bold.woff') format('woff'),
                 url('font/DSEG7Modern-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }

        /* カスタムフォントを適用 */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* タイマー表示用の7セグメントフォント */
        #timer-display {
            font-family: 'DSEG7 Modern', monospace;
            font-weight: bold;
        }
        /* ビューポート単位でフォントサイズを調整し、画面幅に応じてスケールさせる */
        #timer-display {
            /* vw値を調整してはみ出しを防止 */
            font-size: clamp(1rem, 18vw, 12rem);
            line-height: 1;
        }
        /* ボタンのトランジション */
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-start {
            background-color: #4f46e5; /* Indigo 600 */
        }
        .btn-start:hover:not(:disabled) {
            background-color: #4338ca; /* Indigo 700 */
        }
        .btn-stop {
            background-color: #dc2626; /* Red 600 */
        }
        .btn-stop:hover:not(:disabled) {
            background-color: #b91c1c; /* Red 700 */
        }
        .btn-reset {
            background-color: #6b7280; /* Gray 500 */
        }
        .btn-reset:hover:not(:disabled) {
            background-color: #4b5563; /* Gray 600 */
        }
        .btn-add {
            background-color: #16a34a; /* Green 600 */
        }
        .btn-add:hover:not(:disabled) {
            background-color: #15803d; /* Green 700 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col items-center justify-center min-h-screen p-4">

        <!-- タイマー表示エリア -->
        <div id="timer-display" class="text-gray-800 mb-8 text-center">
            00:00:00.00
        </div>

        <!-- コントロールパネル -->
        <div class="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-lg space-y-6">

            <!-- タイマー設定 -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold">タイマー設定</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- 時間 -->
                    <div>
                        <label for="hours" class="block text-sm font-medium text-gray-700">時間 (Hour)</label>
                        <select id="hours" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <!-- 分 -->
                    <div>
                        <label for="minutes" class="block text-sm font-medium text-gray-700">分 (Minute)</label>
                        <select id="minutes" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <!-- 秒 -->
                    <div>
                        <label for="seconds" class="block text-sm font-medium text-gray-700">秒 (Second)</label>
                        <select id="seconds" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button id="start-btn" class="btn btn-start text-white font-bold py-3 px-4 rounded-lg w-full">スタート</button>
                    <button id="stop-btn" class="btn btn-stop text-white font-bold py-3 px-4 rounded-lg w-full" disabled>ストップ</button>
                    <button id="reset-btn" class="btn btn-reset text-white font-bold py-3 px-4 rounded-lg w-full">リセット</button>
                </div>
            </div>

            <hr>

            <!-- アラーム設定 -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold">アラーム設定</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                    <!-- 時間 -->
                    <div class="sm:col-span-1">
                        <label for="alarm-hours" class="block text-sm font-medium text-gray-700">時間</label>
                        <select id="alarm-hours" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <!-- 分 -->
                    <div class="sm:col-span-1">
                        <label for="alarm-minutes" class="block text-sm font-medium text-gray-700">分</label>
                        <select id="alarm-minutes" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <!-- 秒 -->
                    <div class="sm:col-span-1">
                        <label for="alarm-seconds" class="block text-sm font-medium text-gray-700">秒</label>
                        <select id="alarm-seconds" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                    </div>
                    <div class="sm:col-span-1">
                        <button id="add-alarm-btn" class="btn btn-add text-white font-bold py-2 px-4 rounded-lg w-full">追加</button>
                    </div>
                </div>
                <div id="alarm-list" class="text-sm text-gray-600">
                    <p id="no-alarm-text">アラームは設定されていません。</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const timerDisplay = document.getElementById('timer-display');
        const hoursSelect = document.getElementById('hours');
        const minutesSelect = document.getElementById('minutes');
        const secondsSelect = document.getElementById('seconds');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const resetBtn = document.getElementById('reset-btn');

        const alarmHoursSelect = document.getElementById('alarm-hours');
        const alarmMinutesSelect = document.getElementById('alarm-minutes');
        const alarmSecondsSelect = document.getElementById('alarm-seconds');
        const addAlarmBtn = document.getElementById('add-alarm-btn');
        const alarmList = document.getElementById('alarm-list');
        const noAlarmText = document.getElementById('no-alarm-text');

        // 変数の初期化
        let timerInterval = null;
        let totalMilliseconds = 0;
        let isRunning = false;
        let isCountingUp = false;
        let alarms = []; // { time: (ms), triggered: false }
        
        // Tone.jsのシンセサイザーを準備（時報のような音に設定）
        const synth = new Tone.Synth({
            oscillator: {
                type: 'sine' // 時報のような純粋な音にするためサイン波を選択
            },
            envelope: {
                attack: 0.005, // 素早いアタック
                decay: 0.1,    // ディケイ
                sustain: 0.3,  // サステイン
                release: 1     // 長めのリリースで余韻を残す
            }
        }).toDestination();

        // ドロップダウンに数値を設定する関数
        const populateSelect = (select, max, pad = true) => {
            for (let i = 0; i <= max; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = pad ? String(i).padStart(2, '0') : i;
                select.appendChild(option);
            }
        };

        // 時間をフォーマットする関数 (HH:MM:SS.ss)
        const formatTime = (ms) => {
            const absoluteMs = Math.abs(ms);
            const h = Math.floor(absoluteMs / 3600000);
            const m = Math.floor((absoluteMs % 3600000) / 60000);
            const s = Math.floor((absoluteMs % 60000) / 1000);
            const cs = Math.floor((absoluteMs % 1000) / 10); // センチ秒 (1/100秒)

            const sign = ms < 0 ? '-' : '';
            return `${sign}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${String(cs).padStart(2, '0')}`;
        };

        // タイマー表示を更新する関数
        const updateDisplay = () => {
            timerDisplay.textContent = formatTime(totalMilliseconds);
            if (isCountingUp) {
                timerDisplay.classList.add('text-red-600');
            } else {
                timerDisplay.classList.remove('text-red-600');
            }
        };

        // タイマーのメインループ
        const tick = () => {
            if (isCountingUp) {
                totalMilliseconds += 10;
            } else {
                totalMilliseconds -= 10;
                if (totalMilliseconds <= 0) {
                    totalMilliseconds = 0;
                    isCountingUp = true;
                    // カウントアップ開始時にベルを鳴らす
                    playBell();
                }
            }
            
            checkAlarms();
            updateDisplay();
        };

        // アラームをチェックする関数
        const checkAlarms = () => {
            const currentTime = totalMilliseconds;
            alarms.forEach(alarm => {
                // カウントダウン中とカウントアップ中で条件を分ける
                // カウントダウン: alarm.time が現在の残り時間と一致
                // カウントアップ: alarm.time が 0 (タイマー終了時) または負の値 (カウントアップ中の指定時間)
                const targetTime = isCountingUp ? -alarm.time : alarm.time;

                // 10msの誤差を許容
                if (!alarm.triggered && Math.abs(currentTime - targetTime) < 10) {
                    playBell();
                    alarm.triggered = true; 
                    // アラーム表示を更新（例：打ち消し線を追加）
                    const alarmEl = document.getElementById(`alarm-${alarm.id}`);
                    if(alarmEl) {
                        alarmEl.classList.add('line-through', 'text-gray-400');
                    }
                }
            });
        };
        
        // ベルを鳴らす関数
        const playBell = () => {
            // Tone.jsがユーザー操作によって開始される必要がある
            Tone.start().then(() => {
                // 時報で使われる880Hz(A5)の音を0.2秒間鳴らす
                synth.triggerAttackRelease("880", "0.2s");
            }).catch(e => {
                console.error("Audio context could not be started: ", e);
            });
        };

        // スタートボタンの処理
        const startTimer = () => {
            if (isRunning) return;

            // タイマーが0で、カウントアップ中でもない場合、設定値を取得
            if (totalMilliseconds === 0 && !isCountingUp) {
                 const h = parseInt(hoursSelect.value, 10);
                 const m = parseInt(minutesSelect.value, 10);
                 const s = parseInt(secondsSelect.value, 10);
                 totalMilliseconds = (h * 3600 + m * 60 + s) * 1000;
            }

            // 何も設定されていない場合は開始しない
            if (totalMilliseconds <= 0 && !isCountingUp) {
                return;
            }

            isRunning = true;
            // 10ミリ秒ごとにtick関数を呼び出す
            timerInterval = setInterval(tick, 10);

            // ボタンの状態を更新
            startBtn.disabled = true;
            stopBtn.disabled = false;
            resetBtn.disabled = false;
            // 設定セレクトボックスを無効化
            hoursSelect.disabled = true;
            minutesSelect.disabled = true;
            secondsSelect.disabled = true;
        };

        // ストップボタンの処理
        const stopTimer = () => {
            if (!isRunning) return;
            isRunning = false;
            clearInterval(timerInterval);
            
            // ボタンの状態を更新
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
        
        // リセットボタンの処理
        const resetTimer = () => {
            stopTimer();
            totalMilliseconds = 0;
            isCountingUp = false;
            alarms.forEach(a => a.triggered = false); // アラームのトリガー状態をリセット
            updateDisplay();
            resetAlarmListDisplay();

            // ボタンの状態を初期化
            startBtn.disabled = false;
            stopBtn.disabled = true;
            resetBtn.disabled = false; // リセットはいつでも押せるように
            // 設定セレクトボックスを有効化
            hoursSelect.disabled = false;
            minutesSelect.disabled = false;
            secondsSelect.disabled = false;
        };

        // アラーム追加の処理
        const addAlarm = () => {
            const h = parseInt(alarmHoursSelect.value, 10);
            const m = parseInt(alarmMinutesSelect.value, 10);
            const s = parseInt(alarmSecondsSelect.value, 10);
            
            const alarmTimeMs = (h * 3600 + m * 60 + s) * 1000;

            // 既に同じアラームが存在しないかチェック
            if (alarms.some(alarm => alarm.time === alarmTimeMs)) {
                // ここでユーザーに通知するUIを追加しても良い
                console.log("同じ時間のアラームが既に設定されています。");
                return;
            }
            
            const newAlarm = {
                id: Date.now(), // ユニークなID
                time: alarmTimeMs,
                triggered: false
            };
            alarms.push(newAlarm);
            
            // アラームリストの表示を更新
            updateAlarmListDisplay();
        };

        // アラームリストの表示を更新する関数
        const updateAlarmListDisplay = () => {
            noAlarmText.style.display = 'none';
            // 最新のアラームを取得
            const latestAlarm = alarms[alarms.length - 1];
            const alarmTimeStr = formatTime(latestAlarm.time).split('.')[0]; // ミリ秒を除外

            const alarmEl = document.createElement('div');
            alarmEl.id = `alarm-${latestAlarm.id}`;
            alarmEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
            alarmEl.innerHTML = `
                <span>設定: ${alarmTimeStr}</span>
                <button data-id="${latestAlarm.id}" class="remove-alarm-btn text-red-500 hover:text-red-700 font-bold">削除</button>
            `;
            alarmList.appendChild(alarmEl);

            // 削除ボタンにイベントリスナーを追加
            alarmEl.querySelector('.remove-alarm-btn').addEventListener('click', (e) => {
                const idToRemove = Number(e.target.dataset.id);
                alarms = alarms.filter(a => a.id !== idToRemove);
                e.target.parentElement.remove();
                if (alarms.length === 0) {
                    noAlarmText.style.display = 'block';
                }
            });
        };

        // アラームリストの表示をリセットする関数
        const resetAlarmListDisplay = () => {
            alarmList.innerHTML = ''; // 中身を空にする
            alarmList.appendChild(noAlarmText); // 「設定されていません」を再表示
            noAlarmText.style.display = 'block';
            // アラームリストの各要素のスタイルもリセット
            alarms.forEach(alarm => {
                const alarmEl = document.getElementById(`alarm-${alarm.id}`);
                if(alarmEl) {
                    alarmEl.classList.remove('line-through', 'text-gray-400');
                }
            });
        };


        // 初期化処理
        const initialize = () => {
            // タイマー設定用ドロップダウン
            populateSelect(hoursSelect, 24);
            populateSelect(minutesSelect, 59);
            populateSelect(secondsSelect, 59);
            
            // アラーム設定用ドロップダウン
            populateSelect(alarmHoursSelect, 11);
            populateSelect(alarmMinutesSelect, 59);
            populateSelect(alarmSecondsSelect, 59);

            // イベントリスナーの設定
            startBtn.addEventListener('click', startTimer);
            stopBtn.addEventListener('click', stopTimer);
            resetBtn.addEventListener('click', resetTimer);
            addAlarmBtn.addEventListener('click', addAlarm);
            
            updateDisplay();
        };

        // ページ読み込み完了時に初期化
        window.onload = initialize;
    </script>
</body>
</html>
